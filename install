#!/usr/bin/env zsh

BASE_DIR=$( cd $( dirname ${(%):-%x} ) &> /dev/null && pwd )
source ${BASE_DIR}/lib/colors
failure_log=/tmp/install_failures_$$
manual_log=/tmp/install_manual_$$
caveat_log=/tmp/install_caveats_$$

echo -e "${BOLD}${BLUE}Starting macOS install...${NC}"
echo ""

# Phase 1: Bootstrap Homebrew
echo -e "${BLUE}Phase 1:${NC} Bootstrap Homebrew"
${BASE_DIR}/brew/install

# Setup brew in PATH for this session
if [[ -f /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -f /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi

# Phase 2: Brew packages
echo -e "\n${BLUE}Phase 2:${NC} Brew packages"
${BASE_DIR}/lib/install-tools brew $failure_log $manual_log $caveat_log

# Add brew curl to PATH (keg-only, needed for SSL on corporate networks)
if [[ -d /opt/homebrew/opt/curl/bin ]]; then
    export PATH="/opt/homebrew/opt/curl/bin:$PATH"
fi

# Phase 3: Shell configs
echo -e "\n${BLUE}Phase 3:${NC} Shell configs"
${BASE_DIR}/bash/install
${BASE_DIR}/zsh/install

# Phase 4: Mise version manager
echo -e "\n${BLUE}Phase 4:${NC} Mise version manager"
${BASE_DIR}/mise/install
if command -v mise >/dev/null 2>&1; then
    eval "$(mise activate zsh)"
fi

# Phase 5: Mise-managed tools
echo -e "\n${BLUE}Phase 5:${NC} Mise-managed tools"
${BASE_DIR}/lib/install-tools mise $failure_log $manual_log

# Phase 6: NPM packages
echo -e "\n${BLUE}Phase 6:${NC} NPM packages"
${BASE_DIR}/lib/install-tools npm $failure_log $manual_log

# Phase 7: Brew casks
echo -e "\n${BLUE}Phase 7:${NC} Brew casks"
${BASE_DIR}/lib/install-tools brew-cask $failure_log $manual_log

# Phase 8: Google Cloud components
echo -e "\n${BLUE}Phase 8:${NC} Google Cloud components"
${BASE_DIR}/lib/install-tools gcloud $failure_log $manual_log

# Phase 9: Python tools (via uv)
echo -e "\n${BLUE}Phase 9:${NC} Python tools"
${BASE_DIR}/lib/install-tools uv $failure_log $manual_log

# Phase 10: Mac App Store apps
echo -e "\n${BLUE}Phase 10:${NC} Mac App Store apps"
${BASE_DIR}/lib/install-tools mas $failure_log $manual_log

# Phase 11: Cursor extensions
echo -e "\n${BLUE}Phase 11:${NC} Cursor extensions"
${BASE_DIR}/lib/install-tools cursor $failure_log $manual_log

# Phase 12: VS Code extensions
echo -e "\n${BLUE}Phase 12:${NC} VS Code extensions"
${BASE_DIR}/lib/install-tools vscode $failure_log $manual_log

# Phase 13: Custom configs
echo -e "\n${BLUE}Phase 13:${NC} Custom configs"
${BASE_DIR}/git/install
${BASE_DIR}/vim/install

# Phase 14: AI tool configs
echo -e "\n${BLUE}Phase 14:${NC} AI tool configs"
${BASE_DIR}/antigravity/install
${BASE_DIR}/claude/install
${BASE_DIR}/codex/install
${BASE_DIR}/cursor/install
${BASE_DIR}/gemini/install

# Final summary
has_failures=false
has_manual=false
has_caveats=false
[[ -f $failure_log ]] && has_failures=true
[[ -f $manual_log ]] && has_manual=true
[[ -f $caveat_log ]] && has_caveats=true

echo ""
echo -e "${GREEN}========================================${NC}"
echo -e "${GREEN}${BOLD}Install Complete${NC}"
echo -e "${GREEN}========================================${NC}"

if [[ "$has_failures" == "true" || "$has_manual" == "true" || "$has_caveats" == "true" ]]; then
    echo ""
    echo -e "${YELLOW}========================================${NC}"
    echo -e "${YELLOW}${BOLD}Summary${NC}"
    echo -e "${YELLOW}========================================${NC}"

    if [[ "$has_failures" == "true" ]]; then
        echo ""
        echo -e "${BOLD}Failed:${NC}"
        cat $failure_log
        rm $failure_log
    fi

    if [[ "$has_manual" == "true" ]]; then
        echo ""
        echo -e "${YELLOW}${BOLD}Manual Installs (not managed by brew):${NC}"
        cat $manual_log
        rm $manual_log
    fi

    if [[ "$has_caveats" == "true" ]]; then
        echo ""
        echo -e "${CYAN}${BOLD}Caveats (action may be required):${NC}"
        cat $caveat_log
        rm $caveat_log
    fi

    echo ""
    if [[ "$has_failures" == "true" ]]; then
        echo -e "${RED}✗${NC} ${BOLD}Some tools failed to install${NC}"
    else
        echo -e "${GREEN}✓${NC} ${BOLD}All tools installed successfully${NC}"
    fi
else
    echo ""
    echo -e "${GREEN}✓${NC} ${BOLD}All tools installed successfully${NC}"
fi
